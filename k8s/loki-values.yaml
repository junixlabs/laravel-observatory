# Laravel Observatory - Promtail Configuration
# Merge with your existing loki-stack values

promtail:
  config:
    snippets:
      extraScrapeConfigs: |
        - job_name: laravel-observatory
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            # Only scrape pods with observatory.scrape annotation
            - source_labels: [__meta_kubernetes_pod_annotation_observatory_scrape]
              action: keep
              regex: "true"
            # Set job label from annotation
            - source_labels: [__meta_kubernetes_pod_annotation_observatory_job]
              target_label: job
            # Standard Kubernetes labels
            - source_labels: [__meta_kubernetes_namespace]
              target_label: namespace
            - source_labels: [__meta_kubernetes_pod_name]
              target_label: pod
            - source_labels: [__meta_kubernetes_pod_label_app]
              target_label: app
            - source_labels: [__meta_kubernetes_pod_container_name]
              target_label: container
            # CRITICAL: Set __path__ to container log files
            - source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__
              separator: /
              replacement: /var/log/pods/*$1/$2/*.log
          pipeline_stages:
            - cri: {}
            - json:
                expressions:
                  message: message
                  context: context
            - json:
                source: context
                expressions:
                  type: type
                  method: method
                  status_code: status_code
                  duration_ms: duration_ms
                  service: service
                  user_id: user_id
                  workspace_id: workspace_id
                  job_name: job_name
                  exception_class: exception_class
            - labels:
                message:
                type:
                method:
                status_code:
                service:
                workspace_id:
                job_name:
                exception_class:
